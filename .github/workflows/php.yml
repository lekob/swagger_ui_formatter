name: PHP Composer

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:

    runs-on: ubuntu-latest
    strategy:
      matrix:
        php-versions: ['7.4']

    steps:
    - name: Install PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-versions }}
    - name: Composer Install Drupal codebase
      run: |
        composer create-project --no-progress drupal/recommended-project:^8.9 .
      
    - name: Checkout Wodby containers
      uses: actions/checkout@v2
      with:
        repository: wodby/docker4drupal
        ref: 5.4.24
        path: ./tools/wodby

    - name: Start up Wodby containers
      run: cp ./tools/wodby/docker-compose.yml ./tools/wodby/.env . && docker-compose up --build -d

    - name: Install Drupal
      run: |
        composer require --no-progress drush/drush
        cp ./web/sites/default/default.settings.php ./web/sites/default/settings.php
        chmod a+w ./web/sites/default/settings.php
        chmod a+w ./web/sites/default
        docker-compose exec -T php bash -c "drush si --db-url=mysql://drupal:drupal@mariadb:3306/drupal -y"

    - name: Instal Swagger UI Formatter
      uses: actions/checkout@v2
      with:
        path: ./web/modules/custom/swagger_ui_formatter

    - name: Install Swagger UI Formatter development dependencies
      run: cd ./web/modules/custom/swagger_ui_formatter && composer install --no-progress
